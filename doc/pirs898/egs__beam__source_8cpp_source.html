<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EGSnrc C++ class library: /home/ftessier/EGSnrc/HEN_HOUSE/egs++/sources/egs_beam_source/egs_beam_source.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">EGSnrc C++ class library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/home/ftessier/EGSnrc/HEN_HOUSE/egs++/sources/egs_beam_source/egs_beam_source.cpp</h1>  </div>
</div>
<div class="contents">
<a href="egs__beam__source_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">###############################################################################</span>
<a name="l00003"></a>00003 <span class="comment">#</span>
<a name="l00004"></a>00004 <span class="comment">#  EGSnrc egs++ beam source</span>
<a name="l00005"></a>00005 <span class="comment">#  Copyright (C) 2015 National Research Council Canada</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment">#  This file is part of EGSnrc.</span>
<a name="l00008"></a>00008 <span class="comment">#</span>
<a name="l00009"></a>00009 <span class="comment">#  EGSnrc is free software: you can redistribute it and/or modify it under</span>
<a name="l00010"></a>00010 <span class="comment">#  the terms of the GNU Affero General Public License as published by the</span>
<a name="l00011"></a>00011 <span class="comment">#  Free Software Foundation, either version 3 of the License, or (at your</span>
<a name="l00012"></a>00012 <span class="comment">#  option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment">#</span>
<a name="l00014"></a>00014 <span class="comment">#  EGSnrc is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00015"></a>00015 <span class="comment">#  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00016"></a>00016 <span class="comment">#  FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00017"></a>00017 <span class="comment">#  more details.</span>
<a name="l00018"></a>00018 <span class="comment">#</span>
<a name="l00019"></a>00019 <span class="comment">#  You should have received a copy of the GNU Affero General Public License</span>
<a name="l00020"></a>00020 <span class="comment">#  along with EGSnrc. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00021"></a>00021 <span class="comment">#</span>
<a name="l00022"></a>00022 <span class="comment">###############################################################################</span>
<a name="l00023"></a>00023 <span class="comment">#</span>
<a name="l00024"></a>00024 <span class="comment">#  Author:          Iwan Kawrakow, 2005</span>
<a name="l00025"></a>00025 <span class="comment">#</span>
<a name="l00026"></a>00026 <span class="comment">#  Contributors:    Blake Walters</span>
<a name="l00027"></a>00027 <span class="comment">#                   Frederic Tessier</span>
<a name="l00028"></a>00028 <span class="comment">#</span>
<a name="l00029"></a>00029 <span class="comment">###############################################################################</span>
<a name="l00030"></a>00030 <span class="comment">*/</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="egs__beam__source_8h.html" title="A BEAM simulation source.">egs_beam_source.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;egs_input.h&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;egs_functions.h&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;egs_library.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;egs_application.h&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#define STRINGIFY(s) HELP_S(s)</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define HELP_S(s) #s</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#define F77_NAME(fname,FNAME) STRINGIFY(F77_OBJ(fname,FNAME))</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define F77_NAME_(fname,FNAME) STRINGIFY(F77_OBJ_(fname,FNAME))</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="classEGS__BeamSource.html#a4acdbc7914aee4e08be567201f5dd836">00052</a> <a class="code" href="classEGS__BeamSource.html#a4acdbc7914aee4e08be567201f5dd836" title="Create a BEAM simulation source from the input inp.">EGS_BeamSource::EGS_BeamSource</a>(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *input, <a class="code" href="classEGS__ObjectFactory.html" title="An object factory.">EGS_ObjectFactory</a> *f) :
<a name="l00053"></a>00053     <a class="code" href="classEGS__BaseSource.html" title="Base source class. All particle sources must be derived from this class.">EGS_BaseSource</a>(input,f) {
<a name="l00054"></a>00054     n_reuse_photon = 0;
<a name="l00055"></a>00055     n_reuse_electron = 0;
<a name="l00056"></a>00056     i_reuse_photon = 0;
<a name="l00057"></a>00057     i_reuse_electron = 0;
<a name="l00058"></a>00058     is_valid = <span class="keyword">false</span>;
<a name="l00059"></a>00059     <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a> = 0;
<a name="l00060"></a>00060     Xmin = -1e30;
<a name="l00061"></a>00061     Xmax = 1e30;
<a name="l00062"></a>00062     Ymin = -1e30;
<a name="l00063"></a>00063     Ymax = 1e30;
<a name="l00064"></a>00064     wmin = -1e30;
<a name="l00065"></a>00065     wmax = 1e30;
<a name="l00066"></a>00066     <span class="keywordtype">string</span> beam_code;
<a name="l00067"></a>00067     <span class="keywordtype">int</span> err1 = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;beam code&quot;</span>,beam_code);
<a name="l00068"></a>00068     <span class="keywordtype">string</span> pegs_file;
<a name="l00069"></a>00069     <span class="keywordtype">int</span> err2 = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;pegs file&quot;</span>,pegs_file);
<a name="l00070"></a>00070     <span class="keywordtype">string</span> input_file;
<a name="l00071"></a>00071     <span class="keywordtype">int</span> err3 = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;input file&quot;</span>,input_file);
<a name="l00072"></a>00072     <span class="keywordflow">if</span> (err1) {
<a name="l00073"></a>00073         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: no &#39;beam code&#39; input\n&quot;</span>);
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075     <span class="keywordflow">if</span> (err2) {
<a name="l00076"></a>00076         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: no &#39;pegs file&#39; input\n&quot;</span>);
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078     <span class="keywordflow">if</span> (err3) {
<a name="l00079"></a>00079         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: no &#39;input file&#39; input\n&quot;</span>);
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081     <span class="keywordflow">if</span> (err1 || err2 || err3) {
<a name="l00082"></a>00082         <span class="keywordflow">return</span>;
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     <span class="keywordtype">char</span> *egs_home = getenv(<span class="stringliteral">&quot;EGS_HOME&quot;</span>);
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (!egs_home) {
<a name="l00086"></a>00086         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: EGS_HOME is not defined\n&quot;</span>);
<a name="l00087"></a>00087         <span class="keywordflow">return</span>;
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089     <span class="keywordtype">char</span> *hen_house = getenv(<span class="stringliteral">&quot;HEN_HOUSE&quot;</span>);
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (!hen_house) {
<a name="l00091"></a>00091         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: HEN_HOUSE is not defined\n&quot;</span>);
<a name="l00092"></a>00092         <span class="keywordflow">return</span>;
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     <span class="keywordtype">string</span> path = egs_home;
<a name="l00095"></a>00095     path += <span class="stringliteral">&quot;bin/&quot;</span>;
<a name="l00096"></a>00096     path += CONFIG_NAME;
<a name="l00097"></a>00097     <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a> = <span class="keyword">new</span> <a class="code" href="classEGS__Library.html" title="A class for dynamically loading shared libraries.">EGS_Library</a>(beam_code.c_str(),path.c_str());
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     InitFunction init = (InitFunction)
<a name="l00100"></a>00100                         <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>-&gt;<a class="code" href="classEGS__Library.html#af15b61aa1f79ae7d94d154b719e46b3b" title="Returns the address of the exported symbol func.">resolve</a>(F77_NAME_(beamlib_init,BEAMLIB_INIT));
<a name="l00101"></a>00101     <a class="code" href="classEGS__BeamSource.html#ab6ba2ebfcfcb09d59d9ea151f726a1bd">finish</a> = (FinishFunction)
<a name="l00102"></a>00102              <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>-&gt;<a class="code" href="classEGS__Library.html#af15b61aa1f79ae7d94d154b719e46b3b" title="Returns the address of the exported symbol func.">resolve</a>(F77_NAME_(beamlib_finish,BEAMLIB_FINISH));
<a name="l00103"></a>00103     <a class="code" href="classEGS__BeamSource.html#a0d434e85caf37389cf35638d3e83286f" title="The function that returns the next particle.">sample</a> = (SampleFunction)
<a name="l00104"></a>00104              <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>-&gt;<a class="code" href="classEGS__Library.html#af15b61aa1f79ae7d94d154b719e46b3b" title="Returns the address of the exported symbol func.">resolve</a>(F77_NAME_(beamlib_sample,BEAMLIB_SAMPLE));
<a name="l00105"></a>00105     MaxEnergyFunction maxenergy = (MaxEnergyFunction)
<a name="l00106"></a>00106                                   <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>-&gt;<a class="code" href="classEGS__Library.html#af15b61aa1f79ae7d94d154b719e46b3b" title="Returns the address of the exported symbol func.">resolve</a>(F77_NAME_(beamlib_max_energy,BEAMLIB_MAX_ENERGY));
<a name="l00107"></a>00107     <span class="keywordflow">if</span> (!init) {
<a name="l00108"></a>00108         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: failed to resolve the init function\n&quot;</span>);
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (!<a class="code" href="classEGS__BeamSource.html#a0d434e85caf37389cf35638d3e83286f" title="The function that returns the next particle.">sample</a>) {
<a name="l00111"></a>00111         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: failed to resolve the sample function\n&quot;</span>);
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (!<a class="code" href="classEGS__BeamSource.html#ab6ba2ebfcfcb09d59d9ea151f726a1bd">finish</a>) {
<a name="l00114"></a>00114         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: failed to resolve the finish function\n&quot;</span>);
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (!maxenergy) {
<a name="l00117"></a>00117         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_BeamSource: failed to resolve the max. energy function\n&quot;</span>);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (!init || !<a class="code" href="classEGS__BeamSource.html#a0d434e85caf37389cf35638d3e83286f" title="The function that returns the next particle.">sample</a> || !<a class="code" href="classEGS__BeamSource.html#ab6ba2ebfcfcb09d59d9ea151f726a1bd">finish</a> || !maxenergy) {
<a name="l00120"></a>00120         <span class="keywordflow">return</span>;
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="keywordtype">int</span> ipar=0, ilog=6;
<a name="l00124"></a>00124     <a class="code" href="classEGS__Application.html" title="Base class for advanced EGSnrc C++ applications.">EGS_Application</a> *app = <a class="code" href="classEGS__Application.html#a0bacaf36aa14a5851c5dd6f8efd679ee" title="Get the active application.">EGS_Application::activeApplication</a>();
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (app) {
<a name="l00126"></a>00126         ipar = app-&gt;<a class="code" href="classEGS__Application.html#a978f88293d28c1b715f4a3580e6c2b38" title="Returns the job number in a parallel run.">getIparallel</a>();
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     init(&amp;ipar,&amp;ilog,hen_house,egs_home,beam_code.c_str(),
<a name="l00130"></a>00130          pegs_file.c_str(),input_file.c_str(),
<a name="l00131"></a>00131          strlen(hen_house), strlen(egs_home),
<a name="l00132"></a>00132          beam_code.size(),pegs_file.size(),input_file.size());
<a name="l00133"></a>00133     maxenergy(&amp;Emax);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     is_valid = <span class="keyword">true</span>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     vector&lt;EGS_Float&gt; cutout;
<a name="l00138"></a>00138     <span class="keywordtype">int</span> err = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;cutout&quot;</span>,cutout);
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (!err &amp;&amp; cutout.size() == 4) {
<a name="l00140"></a>00140         setCutout(cutout[0],cutout[1],cutout[2],cutout[3]);
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142     vector&lt;string&gt; ptype;
<a name="l00143"></a>00143     ptype.push_back(<span class="stringliteral">&quot;electrons&quot;</span>);
<a name="l00144"></a>00144     ptype.push_back(<span class="stringliteral">&quot;photons&quot;</span>);
<a name="l00145"></a>00145     ptype.push_back(<span class="stringliteral">&quot;positrons&quot;</span>);
<a name="l00146"></a>00146     ptype.push_back(<span class="stringliteral">&quot;all&quot;</span>);
<a name="l00147"></a>00147     ptype.push_back(<span class="stringliteral">&quot;charged&quot;</span>);
<a name="l00148"></a>00148     particle_type = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;particle type&quot;</span>,ptype,3)-1;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     vector&lt;EGS_Float&gt; wwindow;
<a name="l00151"></a>00151     err = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;weight window&quot;</span>,wwindow);
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (!err &amp;&amp; wwindow.size() == 2) {
<a name="l00153"></a>00153         wmin = wwindow[0];
<a name="l00154"></a>00154         wmax = wwindow[1];
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keywordtype">int</span> ntmp;
<a name="l00158"></a>00158     err = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;reuse photons&quot;</span>,ntmp);
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (!err &amp;&amp; ntmp &gt; 1) {
<a name="l00160"></a>00160         n_reuse_photon = ntmp;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162     err = input-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;reuse electrons&quot;</span>,ntmp);
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (!err &amp;&amp; ntmp &gt; 1) {
<a name="l00164"></a>00164         n_reuse_electron = ntmp;
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <a class="code" href="classEGS__BaseSource.html#a8cd077c4dc46018211a8be539b33493c" title="A short source description.">description</a> = beam_code;
<a name="l00168"></a>00168     <a class="code" href="classEGS__BaseSource.html#a8cd077c4dc46018211a8be539b33493c" title="A short source description.">description</a> += <span class="stringliteral">&quot;(&quot;</span>;
<a name="l00169"></a>00169     <a class="code" href="classEGS__BaseSource.html#a8cd077c4dc46018211a8be539b33493c" title="A short source description.">description</a> += input_file;
<a name="l00170"></a>00170     <a class="code" href="classEGS__BaseSource.html#a8cd077c4dc46018211a8be539b33493c" title="A short source description.">description</a> += <span class="stringliteral">&quot;) simulation source&quot;</span>;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 EGS_I64 EGS_BeamSource::getNextParticle(<a class="code" href="classEGS__RandomGenerator.html" title="Base random number generator class. All random number generators should be derived from this class...">EGS_RandomGenerator</a> *, <span class="keywordtype">int</span> &amp;q,
<a name="l00174"></a>00174                                         <span class="keywordtype">int</span> &amp;latch, EGS_Float &amp;E, EGS_Float &amp;wt, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u) {
<a name="l00175"></a>00175     <span class="keywordflow">if</span> (n_reuse_photon &gt; 0 &amp;&amp; i_reuse_photon &lt; n_reuse_photon) {
<a name="l00176"></a>00176         q = q_save;
<a name="l00177"></a>00177         latch = latch_save;
<a name="l00178"></a>00178         E = E_save;
<a name="l00179"></a>00179         wt = wt_save;
<a name="l00180"></a>00180         x = x_save;
<a name="l00181"></a>00181         u = u_save;
<a name="l00182"></a>00182         ++i_reuse_photon;
<a name="l00183"></a>00183         <span class="keywordflow">return</span> count;
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     <span class="keywordflow">if</span> (n_reuse_electron &gt; 0 &amp;&amp; i_reuse_electron &lt; n_reuse_electron) {
<a name="l00186"></a>00186         q = q_save;
<a name="l00187"></a>00187         latch = latch_save;
<a name="l00188"></a>00188         E = E_save;
<a name="l00189"></a>00189         wt = wt_save;
<a name="l00190"></a>00190         x = x_save;
<a name="l00191"></a>00191         u = u_save;
<a name="l00192"></a>00192         ++i_reuse_electron;
<a name="l00193"></a>00193         <span class="keywordflow">return</span> count;
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     EGS_Float te,tx,ty,tz,tu,tv,tw,twt;
<a name="l00196"></a>00196     <span class="keywordtype">int</span> tq,tlatch,tiphat;
<a name="l00197"></a>00197     <span class="keywordtype">bool</span> ok;
<a name="l00198"></a>00198     <span class="keywordflow">do</span> {
<a name="l00199"></a>00199         <a class="code" href="classEGS__BeamSource.html#a0d434e85caf37389cf35638d3e83286f" title="The function that returns the next particle.">sample</a>(&amp;te,&amp;tx,&amp;ty,&amp;tz,&amp;tu,&amp;tv,&amp;tw,&amp;twt,&amp;tq,&amp;tlatch,&amp;count,&amp;tiphat);
<a name="l00200"></a>00200         <span class="comment">//egsInformation(&quot;EGS_BeamSource::getNextParticle: Got E=%g q=%d wt=%g&quot;</span>
<a name="l00201"></a>00201         <span class="comment">//    &quot; x=(%g,%g,%g) latch=%d count=%lld\n&quot;,te,tq,twt,tx,ty,tz,</span>
<a name="l00202"></a>00202         <span class="comment">//    tlatch,count);</span>
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (tq) {
<a name="l00204"></a>00204             te -= 0.5110034;
<a name="l00205"></a>00205         }
<a name="l00206"></a>00206         ok = <span class="keyword">true</span>;
<a name="l00207"></a>00207         <span class="keywordflow">if</span> (te &gt; Emax) {
<a name="l00208"></a>00208             ok = <span class="keyword">false</span>;
<a name="l00209"></a>00209         } <span class="comment">//egsInformation(&quot;Emax rejection\n&quot;); }</span>
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (particle_type &lt; 2 &amp;&amp; tq != particle_type) {
<a name="l00211"></a>00211             ok = <span class="keyword">false</span>;
<a name="l00212"></a>00212         } <span class="comment">// egsInformation(&quot;charge rejection&quot;); }</span>
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (particle_type == 3 &amp;&amp; !tq) {
<a name="l00214"></a>00214             ok = <span class="keyword">false</span>;
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (tx &lt; Xmin || tx &gt; Xmax || ty &lt; Ymin || ty &gt; Ymax) {
<a name="l00217"></a>00217             ok = <span class="keyword">false</span>;
<a name="l00218"></a>00218         } <span class="comment">// egsInformation(&quot;cutout rejection\n&quot;); }</span>
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (twt &lt; wmin || twt &gt; wmax) {
<a name="l00220"></a>00220             ok = <span class="keyword">false</span>; <span class="comment">// egsInformation(&quot;weight rejection\n&quot;);</span>
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223     <span class="keywordflow">while</span> (!ok);
<a name="l00224"></a>00224     i_reuse_electron = n_reuse_electron;
<a name="l00225"></a>00225     i_reuse_photon = n_reuse_photon;
<a name="l00226"></a>00226     <span class="comment">//egsInformation(&quot;returning particle\n&quot;);</span>
<a name="l00227"></a>00227     E = te;
<a name="l00228"></a>00228     q = tq;
<a name="l00229"></a>00229     latch = 0; <span class="comment">//latch = tlatch;</span>
<a name="l00230"></a>00230     <span class="keywordtype">bool</span> save_it = <span class="keyword">false</span>;
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (n_reuse_photon &gt; 1 &amp;&amp; !tq) {
<a name="l00232"></a>00232         twt /= n_reuse_photon;
<a name="l00233"></a>00233         i_reuse_photon = 1;
<a name="l00234"></a>00234         save_it = <span class="keyword">true</span>;
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (n_reuse_electron &gt; 1 &amp;&amp; tq) {
<a name="l00237"></a>00237         twt /= n_reuse_electron;
<a name="l00238"></a>00238         i_reuse_electron = 1;
<a name="l00239"></a>00239         save_it = <span class="keyword">true</span>;
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241     wt = twt;
<a name="l00242"></a>00242     x = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(tx,ty,tz);
<a name="l00243"></a>00243     u = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(tu,tv,tw);
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (save_it) {
<a name="l00245"></a>00245         q_save = tq;
<a name="l00246"></a>00246         latch_save = 0;
<a name="l00247"></a>00247         E_save = E;
<a name="l00248"></a>00248         wt_save = twt;
<a name="l00249"></a>00249         x_save = x;
<a name="l00250"></a>00250         u_save = u;
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     <span class="keywordflow">return</span> count;
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 EGS_BeamSource::~EGS_BeamSource() {
<a name="l00256"></a>00256     <span class="keywordflow">if</span> (<a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>) {
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (is_valid) {
<a name="l00258"></a>00258             <a class="code" href="classEGS__BeamSource.html#ab6ba2ebfcfcb09d59d9ea151f726a1bd">finish</a>();
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260         <span class="keyword">delete</span> <a class="code" href="classEGS__BeamSource.html#ae4261cf565737d21e8b81b32baf313ee" title="The BEAMnrc user code library.">lib</a>;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     EGS_BEAM_SOURCE_EXPORT <a class="code" href="classEGS__BaseSource.html" title="Base source class. All particle sources must be derived from this class.">EGS_BaseSource</a> *createSource(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *input,
<a name="l00267"></a>00267             <a class="code" href="classEGS__ObjectFactory.html" title="An object factory.">EGS_ObjectFactory</a> *f) {
<a name="l00268"></a>00268         <span class="keywordflow">return</span>
<a name="l00269"></a>00269             createSourceTemplate&lt;EGS_BeamSource&gt;(input,f,<span class="stringliteral">&quot;beam source&quot;</span>);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
